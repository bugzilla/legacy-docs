[%# Developer's Guide %]
[% 
	title = "Developer's Guide" 
%]

<h1>Developer's Guide</h1>
<ul>
    <li><a href="#intro">Introduction</a></li>
    <li><a href="#general">General Guidelines</a></li>
    <li><a href="#bugfixing">Bug Fixing</a></li>
    <li><a href="#testsuite">Test Suite</a></li>
    <li><a href="#allfiles">All Files</a></li>
    <li><a href="#perl">Perl Code</a>
        <ul>
            <li><a href="#perl-general">General</a></li>
            <li><a href="#perl-errors">Throwing Errors</a></li>
            <li><a href="#perl-taint">Taint Mode</a></li>
            <li><a href="#perl-style">Style</a></li>
            <li><a href="#perl-crossplatform">Cross-Platform Compatibility</a></li>
        </ul>
    </li>
    <li><a href="#apidocs">API Documentation</a></li>

    <li><a href="#sql">SQL</a>
        <ul>
            <li><a href="#sql-general">General</a></li>
            <li><a href="#sql-schema">Schema Changes</a></li>
            <li><a href="#sql-sendreceive">How to Send And Receive Information 
                From/To the Database</a></li>
            <li><a href="#sql-join">JOIN Statements and SELECTing 
                From Multiple Tables</a></li>
            <li><a href="#sql-indexes">Indexes</a></li>
            <li><a href="#sql-crossdb">Cross-Database Query 
                Compatibility</a></li>
            <li><a href="#sql-style">Style</a></li>
        </ul>
    </li>
    <li><a href="#templates">Templates</a>
        <ul>
            <li><a href="#templates-general">General</a></li>
            <li><a href="#templates-filenames">Filenames and Paths</a></li>
            <li><a href="#templates-html">HTML Templates</a></li>
            <li><a href="#templates-webtech">Web Technologies</a></li>
        </ul>
    </li>
    <li><a href="#security">Security</a>
        <ul>
            <li><a href="#security-untrusted">Don't Trust URL Parameters 
                And Cookies!</a></li>
            <li><a href="#security-confidential">Confidential Information 
                Leakage</a></li>
            <li><a href="#security-unauthorized">Unauthorized Access to 
                Perform an Action</a></li>
            <li><a href="#security-arbitrarycode">Arbitrary Code 
                Execution</a></li>
        </ul>
    </li>
</ul>




<h1><a name="intro"></a>Introduction</h1>

<p>This document describes the code standards for Bugzilla, and gives tips
   for Bugzilla developers.</p>

<p>Code is most likely to be integrated into Bugzilla if it follows these
   guidelines. Sometimes reviewers will allow you to bend the rules,
   but there must be a very good reason for doing so.</p>

<p>It is always better to contribute <strong>some</strong> code
   rather than <strong>no</strong> code. If your code isn't perfect,
   a reviewer will tell you what you need to change in order for us
   to accept it. Usually, the reviewer will just tell you things that
   are already in this document.</p>

<p>Existing Bugzilla code does not necessarily conform to these guidelines,
   but we are working towards them. If you're only changing 1 or 2 lines,
   there's no need to fix up the entire file to make the file conform to these
   guidelines.</p>


<h1><a name="general"></a>General Guidelines</h1>

<p>We have a certain set of &quot;basic principles&quot; that this entire
   Developer's Guide is based on:</p>

<ul>
    <li>These guidelines exist because they <strong>reduce bugs</strong>
        and <strong>make it easier to change things in the future</strong>.</li>
    <li>Making it easier to change things in the future is important, because
        an important law of code is: <strong>All Code Will Change</strong>.</li>
    <li>Code should be <strong>as simple as possible</strong>. When you write
        code, one of your primary goals should be: <strong>make it easy
        for other programmers to use and read your code</strong>.</li>
    <li><strong>Readable</strong> code is more important than 
        <strong>clever</strong> code.</li>
    <li>If you're trying to be clever instead of trying to be readable, 
        then maybe you're trying to make things &quot;faster?&quot; If so,
        just remember: <strong>don't solve a problem before you 
        <em>know it exists</em></strong>. If you don't <em>know</em> 
        (by actual, detailed tests) that your code is slow, don't worry about
        making it &quot;faster.&quot; This isn't just limited to
        optimization--many programmers are constantly solving problems
        that nobody has ever experienced. Don't do that.</li>
    <li><strong>You cannot introduce new bugs unless you change code.</strong>
        That should be obvious. :-) This means:
        <ul>
            <li><strong>The more code you change, the more bugs you
                <em>will</em> create.</strong> There are no &quot;perfect&quot;
                programmers. Everybody makes a few mistakes now and then.</li>
            <li><strong>The number of bugs introduced by a patch is
                proportional to the size of the patch.</strong></li>
            <li>Thus, <strong>patches should be as small as possible</strong>,
                and should change only what they need to change.</li>
        </ul>
    </li>
    <li>An easy way to check if your code is readable, is to ask yourself,
        &quot;Will another programmer understand this line 
        <em>instantly</em> when they look at it?&quot; If not, that line
        either needs to be re-written or needs a comment.</li>
</ul>



<h1><a name="bugfixing"></a>Bug Fixing</h1>
<p>When you fix a bug, ask yourself:</p>
<ul>
  <li>Where else in the codebase might this bug occur? Search for other
      places, and either fix these or file them as new bug reports.</li>
  <li>How could you, or the Bugzilla team in general, prevent this problem in
      future? Consider reusable subroutines that could be introduced,
      rearchitecture that could be done, or tests that could be added to the
      testing suite. File new bug reports on these.</li>
  <li>Could this have regressed anything?</li>
</ul>



<h1><a name="testsuite"></a>Test Suite</h1>
<p>Nothing will get checked into Bugzilla that doesn't pass the test suite.
   The test suite is automatically executed on each commit by the
   <a href="https://travis-ci.org/bugzilla/bugzilla">Travis CI</a> system to
   warn us of bad code. It is using Bugzilla's
   <a href="https://github.com/bugzilla/bugzilla">github mirror</a>. Anything
   that fails to pass the testing suite will be backed out immediately.</p>

<p>The test suite continues to expand to detect more problems as the
   Bugzilla architecture matures and our understanding of potential problems
   improves. If you add new code, consider adding a new test.</p>

<p>Currently, it primarily diagnoses problems in code similar to a <q>lint</q>
   like tool. However, it does do some tests on the small but growing <q>back
   end</q> of Bugzilla.</p>
<p>In order to run the tests, you must have the
   <span class="module-name">Test::More</span> and
   <span class="module-name">Test::Harness</span> Perl modules installed. You
   can then <span class="shell-command">./runtests.pl</span> or
   <span class="shell-command">./runtests.pl --verbose</span> from your
   Bugzilla main directory.</p>



<h1><a name="allfiles"></a>All Files</h1>
<ul>
  <li>The testing suite will check files have no tab characters. Tabs are not
      reliable for positioning because different editors interpret them
      differently.</li>
  <li>The testing suite will check files for some common or past
      misspellings.</li>
  <li>File names should be legal across multiple platforms. <code>\ / : * ? " &lt;
      &gt;</code> and <code>|</code> are all illegal characters for filenames on various
      platforms. Also, file names should not have spaces in them as they can cause
      confusion in CVS and other mozilla.org utilities.  You may assume long filename
      support is present.</li>
</ul>



<h1><a name="perl"></a>Perl Code</h1>

<h2><a name="perl-general"></a>General</h2>
<ul>
  <li>The testing suite will check all Perl files have no errors. This is
      done by using the <kbd>perl -c</kbd> command to compile the files.</li>
  <li>The testing suite will check that all Perl files have the appropriate
      shebang switches (-w plus -T where required), and that 
      <code class="perl">use strict</code> is present.</li>
  <li><strong>Variable Names</strong> - Do not use global variables 
       (like <code class="perl">$::variable</code>). They make the code
       harder to use and prone to errors as they can be altered at unexpected
       places. Use local variables instead. Their name must be understandable
       and descriptive. For example, <code class="perl">$product</code> could
       be used as a variable referencing a product.</p>
  </li>

  <li><strong>Variables In Regular Expressions</strong> - One common bug is 
       mis-using variables inside of regular expressions.
       When the variable contains regular expression operators such
       as <code class="perl">?</code>, 
       <code class="perl">*</code> and <code class="perl">+</code>, 
       bugs occur. This typically occurs with <code class="perl">grep</code> 
       or <code class="perl">=~</code>. You should use:
    <p><code class="perl">grep ($_ eq $value, @array);</code></p>
    <p>instead of this:</p>
    <p><code class="perl">grep (/$value/, @array);</code></p>
    <p>If you need to use a variable inside of an expression,
       be sure to quote it properly (using <code class="perl">\Q..\E</code>),
       like:</p>
    <p><code class="perl">grep (/blah\Q$value\Eblah/, @array);</code></p>
    <p>If your variable is actually <em>supposed</em> to contain a regular
       expression, then you don't have to escape it. In this case, it is a
       good idea to include &quot;regexp&quot; in the <em>name of the variable</em>, 
       for readability purposes. For example, <code>$search_regexp</code>.</p>
  </li>

  <li>CGIs should call <code class="perl"><a href="https://www.bugzilla.org/docs/tip/html/api/Bugzilla.html#login">Bugzilla-&gt;login</a></code>
      before determining user identity, as this will perform the 
      proper verifications against impersonation.</li>

  <li>All non-obvious pieces of code should have comments explaining 
      what they do, and why they are needed.  This means in 
      particular &quot;hacky kludges&quot; and &quot;workarounds.&quot;</li>
</ul>

<h2><a name="perl-errors">Throwing Errors</a></h2>

<p>Normally, when an error occurs because of user action,
   you call <code class="perl">ThrowUserError</code>, eg:</p>

<p><code class="perl">ThrowUserError("user_made_mistake");</code></p>

<p>whereas when an error occurs because of a situation that
   should never happen (indicating a bug), call 
   <code class="perl">ThrowCodeError</code>, eg:</p>

<p><code class="perl">ThrowCodeError("bugzilla_is_broken");</code></p>

<p>However, when it comes to throwing errors, there are a few 
   important rules:</p>

<ol>
  <li>Don't blame the user if there's doubt whether it's the user's 
      fault.</li>
  <li>Don't tell the user to email the admin if the error doesn't mean 
      Bugzilla is broken.</li>
</ol>

<p>That means: use <code class="perl">ThrowUserError</code> every time
   that Bugzilla isn't <em>broken</em>, even if you're not sure it's
   a user error. This rule overrides the general recommendations at
   the top of this section.</p>



<h2><a name="perl-taint"></a>Taint Mode</h2>

    <p>All new CGIs should run in Perl's taint mode, and existing
       CGIs which run in taint mode must not have taint mode turned off.</p>
    <p>Taint mode works by marking untrusted data as &quot;tainted&quot;, and not
       allowing tainted data to be passed to various places. This ensures a
       multitude of security holes cannot occur.</p>
    <p>For example, the values of <code class="perl">$cgi->param</code> 
       variables and data from browser cookies are tainted, and tainted 
       data may not be passed in to the database. Doing so will cause the CGI to
       generate an error and terminate.</p>
    <p>Instead you must first &quot;detaint&quot; the data. The only way to do this
       directly is to get the untrusted data to match a regular expression and
       extract parts from it. So for example, to detaint a positive
       integer in the variable <code class="perl">$foo</code>:</p>
    <p><code class="perl">
      if ($foo =~ /^(\d+)$/) {<br>
        &nbsp;&nbsp;&nbsp;&nbsp;$foo = $1;<br>
      }<br>
      else {<br>
        &nbsp;&nbsp;&nbsp;&nbsp;# ERROR!<br>
      }<br>
    </code></p>
    <p>Afterwards <code class="perl">$foo</code> will be detainted.</p>
    <p>Note that there are a few convenience functions you should use to make
       life easier:</p>
    <ul>
      <li><code class="perl">detaint_natural</code> detaints a non-negative
          integer as in the example above.</li>
      <li><code class="perl">detaint_signed</code> detaints a signed (negative
           or positive) integer, similar to how 
           <code class="perl">detaint_natural</code> works.</li>
      <li><code class="perl">trick_taint</code> will detaint a piece of data
          unconditionally, but this should only be used when you really know 
          this is OK (as opposed to because you're lazy), because it bypasses
          the taint mode security system. If you use 
          <code class="perl">trick_taint</code>, add a comment explaining
          why it's safe to use it.</li>
    </ul>
    <p>For more information on extracting from regular expressions, see
       <a href="http://search.cpan.org/dist/perl/pod/perlre.pod">perl's 
       documentation on regular expressions</a>. For more information on
       taint mode, see 
       <a href="http://search.cpan.org/dist/perl/pod/perlsec.pod">perl's 
       security documentation</a>.</p>
    <p>Note that Bugzilla does NOT use DBI &quot;taint-out&quot; mode, so data
       <em>returned</em> from the database will not be tainted.</p>


<h2><a name="perl-style"></a>Style</h2>
<ul>
  <li>
    <p>The Bugzilla development team has decided to adopt the Perl style guide
       as published by Larry Wall. This guide can be found in
       <span class="book-name">Programming Perl</span> (the camel book), by 
       typing <span class="shell-command">man perlstyle</span> at your
       favourite shell prompt, or by reading <a href="http://search.cpan.org/dist/perl/pod/perlstyle.pod">the
       latest version</a> online.
    <p>This style is only for Perl. For template style, see the
       template section.</p>
  </li>
  <li>Indentation - Perl code should have 4-space indent.</li>
  <li>
    <p>Curly Braces - The opening brace of a block should be on the same line
       as the statement that is causing the block and the closing brace should
       be at the same indentation level as that statement, for example:</p>
    <p><code class="perl">
      if ($var) {<br>
        &nbsp;&nbsp;&nbsp;&nbsp;print "The variable is true";<br>
      }<br>
      else {<br>
        &nbsp;&nbsp;&nbsp;&nbsp;print "Try again";<br>
      }
    </code></p>
    <p>instead of this:</p>
    <p><code class="perl">
      if ($var) {<br>
        &nbsp;&nbsp;&nbsp;&nbsp;print "The variable is true";<br>
      } else {<br>
        &nbsp;&nbsp;&nbsp;&nbsp;print "Try again";<br>
      }<br>
  </code></p>
  </li>
  <li>Please refer to the perl style guide above if you don't see your
      question covered here.</li>
</ul>



<h2><a name="perl-crossplatform"></a>Cross-Platform Compatibility</h2>
<ul>
  <li>Bugzilla supports *nix platforms, and both ActiveState Perl 
      and cygwin on Win32 platforms.</li>
  <li>
    <p>For this reason, *nix-specific features should either be avoided, or 
       only done if you have ensured the platform is Unix, and the code behaves
       reasonably if not.</p>
    <p>Some examples of *nixisms: chown, chmod, getgrnam, $< et al, stty and
       signal handling.</p>
  </li>
  <li>
    <p>Similarly, some features are supported on cygwin, but not ActiveState
       Perl. You should only use these if you have ensured the platform isn't
       ActiveState.</p>
    <p>Some examples of non-ActiveState features: fork, pipe open syntax (eg
       <code class="perl">open (DOT, '-|')</code>).</p>
  </li>
</ul>



<h1><a name="apidocs"></a>API Documentation</h1>
<ul>
  <li>Recently many Bugzilla modules have been introduced.  Some of these
      even include
      <a href="https://www.bugzilla.org/docs/tip/html/api/">documentation</a>.  Some of
      these files are still empty, though.</li>
</ul>

<p>Want to help out with documenting our code?  Use the following Perl
Documentation example to help you get started:</p>

<pre>
# Perl code can go here.

=head1 NAME

Bugzilla::FlagType - A module to deal with Bugzilla flag types.

=head1 SYNOPSIS

  my $flaginfo = get($flag_id);
  my $count    = count($criteria);
  my $inc_hash = get_inclusions($flag_id);
  my $exc_hash = get_exclusions($flag_id);

=head1 DESCRIPTION

FlagType.pm provides an interface to flag types as stored in Bugzilla.
See below for more information.

=head1 NOTES

=over

=item *

Prior to calling routines in this module, it's assumed that you have
already done a C&lt;require CGI.pl&gt;.

=item *

Use of private functions/variables outside this module may lead to
unexpected results after an upgrade.  Please avoid using private
functions in other files/modules.

=back

=cut

# More perl code can go here.
</pre>

<p>For those that are not familiar with writing POD, here are a few things to be
aware of:</p>

<ul>
  <li>Some documentation is nearly always better than nothing.</li>
  <li>POD commands and blocks always start with an equals (=) sign.</li>
  <li>POD commands must be followed by a blank line to be interpreted properly.</li>
  <li>To end an inline POD block, use the POD command =cut.</li>
  <li>
    <b>
      If you forget your =cut at the end of your POD section, Perl will
      ignore any code that follows until it sees an =cut, or the end of the
      file - whichever comes first.
    </b>
    Many editors like Emacs and VIM have syntax higlighting that understand
    POD.  If you forget your =cut in these editors, you'll see the POD color
    continue beyond where you expected your POD to end.
  </li>
  <li>
    Bugzilla PODs should have most (if not all) of the following head1
    sections:
    <ul>
      <li><code>NAME</code></li>
      <li><code>SYNOPSIS</code></li>
      <li><code>DESCRIPTION</code></li>
      <li><code>METHODS</code></li>
      <li><code>CLASS FUNCTIONS</code></li>
      <li><code>NOTES</code></li>
      <li><code>SEE ALSO</code></li>
    </ul>
  </li>
  <li>
    If your module contains private functions and/or variables, use
    <code>=begin private</code> and <code>=end private</code> to
    hide those functions from POD output, but follow the POD style
    required for those sections.  This allows us to keep the
    documentation in the module in a consistent format without
    telling the whole world all our &quot;trade secrets.&quot;
  </li>
  <li>
    <p>Function descriptions should generally follow the format of:<</p>
    <code>C&lt;function_name($var1, $var2, $var3 ...)&gt;<br>
    Description: Function Description<br>
    Params: Variable Descriptions<br>
    Returns: Return Value</code><br>
    And might look something like this:<br>
<pre>
=item C&lt;GiveHelp($fun, [$color])&gt;<br>

 Description: GiveHelp sends the help string for the $fun function.
 Params:      C&lt;$fun&gt; - The name of the function to be documented.
              C&lt;$color&gt; (optional) - A string. The name of the 
                color of the output.
 Returns:     A string containing HTML-formatted help for C&lt;$fun&gt;.</pre>
  </li>
</ul>

<p>For an example of this POD style, see <code>Bugzilla/DB.pm</code></p>

<p>To learn more about inline Perl Documentation, see the manual pages:</p>

  <ul>
      <li><a href="http://search.cpan.org/dist/perl/pod/perlpod.pod">Basic 
          POD Overview</a></li>
      <li><a href="http://search.cpan.org/dist/perl/pod/perlpodspec.pod">Detailed
          POD Format Specification</a></li>
  </ul>




<h1><a name="sql"></a>SQL</h1>
<h2><a name="sql-general"></a>General</h2>
<ul>
  <li><strong>ANSI SQL</strong> - There are three standards for SQL, 
      <a href="http://savage.net.au/SQL/sql-92.bnf.html">SQL 92</a>,
      <a href="http://savage.net.au/SQL/sql-99.bnf.html">SQL 99</a>,
      and <a href="http://savage.net.au/SQL/sql-2003-2.bnf.html">SQL 2003</a>.
      Bugzilla generally tries to conform to SQL 99, where possible.</li>

  <li>If a feature isn't ANSI-standard, but is supported by all databases
      we support, you can go ahead and use it. You can see all the
      databases we support by looking in the <kbd>Bugzilla/DB/</kbd>
      directory in a Bugzilla installation. (Every <code>.pm</code> file except
      <kbd>Schema.pm</kbd> is a database we support.)</li>

  <li>Many databases have features that are not ANSI-standard, and are
      only supported by that one database. These should only be used
      inside of the <code>Bugzilla::DB</code> structure. For example,
      MySQL-specific code should only be used inside of 
      <code>Bugzilla::DB::Mysql</code> and <code>Bugzilla::DB::Schema::Mysql</code>.</li>

  <li>You shouldn't accept arbitrary SQL from the user, it can easily be a 
      security hole. Short of fully parsing the SQL, use some other method.</li>
  <li>Regular expression searches done by the database (with 
      $dbh-&gt;sql_regexp) use a subset of the regexp language of Perl,
      and not all features that work in Perl will work with the database
      regexps. When in doubt, keep it simple.</li>
  <li>Databases are (almost) always more clever than you at sorting and searching
      data quickly. For this reason, it is typically
      faster to do processing in just one statement than multiple, if you can.
      If you split your statement up, you will reduce the database's
      opportunities to perform the query quickly.</li>
  <li>Never use <code>SELECT *</code> -- always specify the exact columns you
      want. Frequently, the order the columns are returned in is important,
      and if the database schema changes it will be very hard to locate and
      change your code to deal with the change.</li>
  <li>Using Numeric IDs - Tables should use integers rather than string names
      in primary keys. This makes renaming a lot easier and saves database
      space.</li>
  <li>Tables should have <em>singular</em> names. For example, &quot;user&quot;
      instead of &quot;users.&quot;</li>
  <li>It is usually clearer to have your primary key column be named 
      <var>table</var>_id rather than just &quot;id.&quot; For example,
      &quot;bug_id&quot; for the <code>bugs</code> table instead of 
      just &quot;id.&quot;</li>
  <li>Similar to perl style, it is better to use underscores to separate
      different words in column names. &quot;default_qa_contact&quot; is
      easier to read than &quot;defaultqacontact.&quot;</li>
</ul>



<h2><a name="sql-schema"></a>Schema Changes</h2>

<p>If you make schema changes, you should modify:</p>

<ul>
      <li><span class="file-name">Bugzilla/DB/Schema.pm</span>, the 
          <code class="perl">ABSTRACT_SCHEMA</code> variable. Documentation
          on the format is inside of the file itself.</li>
      <li><span class="file-name">Bugzilla::Install::DB</span> to automatically 
          convert old installations. Search for the last occurrence of
          <code>--TABLE--</code> in the file and put your new code
          <em>above</em> that comment.</li>
      <li>(Pre-4.0) <span class="file-name">sanitycheck.cgi</span> to properly 
          check the new schema. This includes updating the "cross checks" 
          (referential checks).</li>
</ul>

<p>If you're changing the definition of a column, your checksetup code
   needs to only run <em>if the column has the old definition</em>. That
   is, it needs to do something like this:</p>

<pre>
# If bugs.qa_contact is currently defined as NOT NULL, re-define it without that.
if ($dbh->bz_column_info('bugs', 'qa_contact')->{NOTNULL}) {
    $dbh->bz_alter_column('bugs', 'qa_contact', {TYPE => 'INT3'});
    ## ... do other stuff here to fix up the new column ... ##
}
</pre>

<h3>How Schema Updates Work</h3>

<p>When Bugzilla updates the on-disk database schema, it also updates a
   Bugzilla::DB::Schema object in the <code>bz_schema</code> table. This
   is in <code>Data::Dumper</code> format, and shows what Bugzilla
   <em>thinks</em> the on-disk structure is.</p>

<p>Why do we do this? Well, because <em>Bugzilla</em> has one idea of what
   a field's type is, and the underlying database frequently has a
   <em>different</em> idea. For example, in MySQL, <code>bugs.bug_id</code>
   has the following definition:</p>

<p><code>bug_id MEDIUMINT AUTO_INCREMENT NOT NULL PRIMARY KEY</code></p>

<p>In PostgreSQL, that same field has the following definition:</p>

<p><code>bug_id SERIAL UNIQUE NOT NULL PRIMARY KEY</code></p>

<p>See how different those are? And yet, to Bugzilla, both of these 
   are represented with the following code:</p>

<p><code>bug_id =&gt; {TYPE =&gt; 'MEDIUMSERIAL', NOTNULL =&gt; 1,
    PRIMARYKEY =&gt; 1}</code></p>

<p>Later, if we want to change bug_id to say, a string (which I hope we 
   never do, but who knows), in <code>checksetup.pl</code> we need to only
   do that change if it's currently <em>not</em> already done. That is,
   we need to check if bug_id is a &quot;MEDIUMSERIAL&quot; and if so,
   change it to a string.</p>

<p>But guess what? The underlying database has no idea if it's a MEDIUMSERIAL.
   But the schema we stored in the <code>bz_schema</code> table, when we first
   installed Bugzilla--it knows!</p>

<p>This becomes even more important when you think about the fact that on
   PostgreSQL, <code>INT1, INT2, INT3,</code> and <code>INT4</code> are 
   <em>all</em> represented as <code>INTEGER</code> on the disk. So 
   sometimes Bugzilla needs to know whether something is an INT3 or an INT2,
   and it can't just ask the database itself. It has to use the information
   stored in the bz_schema table.</p>



<h2><a name="sql-sendreceive"></a>How to Send And Receive Information 
    From/To the Database</h2>

<p>Bugzilla is using standard DBI functions to interact with the database, through
   <code>Bugzilla-&gt;dbh</code>. The current recommended method for creating a
   query is as follows:</p>

<pre>
  use Bugzilla;
  my $dbh = Bugzilla-&gt;dbh; # Connects if not already connected.
                              # Also handles db, user, password...
  my $data = $dbh-&gt;selectall_arrayref(&quot;SELECT foo, bar FROM bath WHERE log = ?&quot;,
                                         undef, &quot;foobar&quot;);

  foreach my $row (@$data) {
      my ($foo, $bar) = @$row;
      # do whatever with $foo and $bar
  }
</pre>

<p>For more information, see the 
   <a href="http://search.cpan.org/dist/DBI/DBI.pm">DBI documentation</a> 
   or the <a href="tip/html/api/Bugzilla/DB.html">Bugzilla::DB 
   documentation</a>.</p>


<h3>Placeholders</h3>

<p>Note that in the above example we use a question mark instead of inserting
   the string &quot;foobar&quot; directly into the SQL. That question mark
   is called a &quot;placeholder.&quot; This is the recommended
   method for passing in <em>all</em> variables into SQL statements.</p>

<p>Here's an example of some SQL with a placeholder:</p>

<p><code class="sql">SELECT short_desc FROM bugs WHERE bug_id = ?</code></p>

<p>Then, your perl code looks something like this:</p>

<pre>
my $bug_id = 2;
my ($short_desc) = 
    $dbh-&gt;selectrow_array(&quot;SELECT short_desc FROM bugs WHERE bug_id = ?&quot;,
                             undef, $bug_id);
</pre>



<h2><a name="sql-join"></a>JOIN Statements and SELECTing 
    From Multiple Tables</h2>

<p>Frequently when using SQL you want data from more than one table at a 
   time. You do this by &quot;joining&quot; the tables in various ways.</p>

<p>For this section, we will be using two tables in our examples, 
   called <var>a</var> and <var>b</var>. Here is what they look like:</p>

<table>
  <tr>
      <th style="border: 1px solid gray">a</th>
      <th style="border: 1px solid gray">b</th>
  </tr>
  <tr>
    <td>
        <table id="table_a" border="1">
            <tr><th>user_id</th><th>user_name</th></tr>
            <tr><td>1</td><td>jdoe</td></tr>
            <tr><td>2</td><td>bsmith</td></tr>
            <tr><td>3</td><td>mkanat</td></tr>
        </table>
    </td>
    <td>
        <table id="table_b" border="1">
            <tr><th>user_id</th><th>email</th></tr>
            <tr><td>1</td><td>jdoe&#64;example.com</td></tr>
            <tr><td>2</td><td>bsmith&#64;example.com</td></tr>
            <tr><td>2</td><td>bsmith&#64;e2.com</td></tr>
        </table>
    </td>
  </tr>
</table>

<p>Note that in the below examples we use <code>SELECT *</code> for
   simplicity, but <a href="#sql-general"><code>SELECT *</code>should
   never be used in Bugzilla code</a>.</p>


<h3>CROSS JOIN</h3>

<p>The <em>least</em> common (but also least understood) type of JOIN is
   the &quot;cross join,&quot; also called the &quot;cross-product join.&quot;</p>

<p>A cross join means, &quot;return all possible combinations of rows in these
   two tables.&quot;</p>

<p>In SQL, there are two ways to do a cross join of tables 
   <var>a</var> and <var>b</var>:</p>

<p><code>SELECT * FROM a, b</code> or <code>SELECT * FROM a CROSS JOIN b</code></p>

<p>The two pieces of code above are identical. The first one is called an
   &quot;implicit&quot; join (because the database just 
   &quot;figures out&quot; that we mean CROSS JOIN, from the comma), and the
   second is called an &quot;explicit&quot; join (because we specified
   exactly what we want).</p>

<p>If we run the SQL above with our <var>a</var> and <var>b</var> tables,
   the result looks like:</p>

<table border="1">
  <tr><th>a.user_id</th><th>a.user_name</th><th>b.user_id</th><th>b.email</th></tr>
  <tr><td>1</td><td>jdoe</td><td>1</td><td>jdoe&#64;example.com</td></tr>
  <tr><td>1</td><td>jdoe</td><td>2</td><td>bsmith&#64;example.com</td></tr>
  <tr><td>1</td><td>jdoe</td><td>2</td><td>bsmith&#64;e2.com</td></tr>

  <tr><td>2</td><td>bsmith</td><td>1</td><td>jdoe&#64;example.com</td></tr>
  <tr><td>2</td><td>bsmith</td><td>2</td><td>bsmith&#64;example.com</td></tr>
  <tr><td>2</td><td>bsmith</td><td>2</td><td>bsmith&#64;e2.com</td></tr>

  <tr><td>3</td><td>mkanat</td><td>1</td><td>jdoe&#64;example.com</td></tr>
  <tr><td>3</td><td>mkanat</td><td>2</td><td>bsmith&#64;example.com</td></tr>
  <tr><td>3</td><td>mkanat</td><td>2</td><td>bsmith&#64;e2.com</td></tr>
</table>

<p>In general, you want to avoid cross joins unless you are certain they are
   exactly what you need.</p>


<h3>INNER JOIN</h3>

<p>An INNER JOIN is one where you try to actually join two tables together
   based on a column that they have in common. This is the most common
   type of join.</p>

<p>For our <var>a</var> and <var>b</var> tables, we have two ways of writing
   an INNER JOIN:</p>

<p><code>SELECT * FROM a INNER JOIN b ON a.user_id = b.user_id</code> or
   <code>SELECT * FROM a, b WHERE a.user_id = b.user_id</code></p>

<p>Just like with the cross join, the first version is an &quot;explicit&quot;
   join, and the second one is an &quot;implicit&quot; join.</p>

<p>The inner join above looks like this:</p>

<table border="1">
  <tr><th>user_id</th><th>user_name</th><th>email</th></tr>
  <tr><td>1</td><td>jdoe</td><td>jdoe&#64;example.com</td></tr>
  <tr><td>2</td><td>bsmith</td><td>bsmith&#64;example.com</td></tr>
  <tr><td>2</td><td>bsmith</td><td>bsmith&#64;e2.com</td></tr>
</table>

<p>Note that &quot;mkanat&quot; (with user_id 3) is left out, because he 
   doesn't have an entry in both tables.</p>


<h3>LEFT JOIN</h3>

<p>A LEFT JOIN is like an INNER JOIN, but it <em>includes</em> records that have an
   entry in <var>a</var> but no corresponding entry in <var>b</var>. That is,
   where &quot;mkanat&quot; was left out in our INNER JOIN above, he would
   be included in our LEFT JOIN.</p>

<p>A LEFT JOIN is normally only done one way:</p>

<p><code>SELECT * FROM a LEFT JOIN b ON a.user_id = b.user_id</code></p>

<p>The result of that code looks like this:</p>

<table border="1">
  <tr><th>user_id</th><th>user_name</th><th>email</th></tr>
  <tr><td>1</td><td>jdoe</td><td>jdoe&#64;example.com</td></tr>
  <tr><td>2</td><td>bsmith</td><td>bsmith&#64;example.com</td></tr>
  <tr><td>2</td><td>bsmith</td><td>bsmith&#64;e2.com</td></tr>
  <tr><td>3</td><td>mkanat</td><td><code>NULL</code></td></tr>
</table>

<p>There was no &quot;email&quot; for &quot;mkanat,&quot; so the database
   returns <code>NULL</code> there.</p>

<p>It's called a &quot;left&quot; join because we include entries from the
   table on the <em>left</em> (table <var>a</var>, note that it's on the 
   left side of the words &quot;LEFT JOIN&quot;) that don't have a match 
   in the table on the right side.</p>

<p><strong>Warning</strong>: If we add a <code>WHERE email = ?</code> to
   the above SQL statement, <em>the row containing mkanat will 
   <strong>never</strong> be returned</em>. This is because <strong>NULL
   is never <em>equal</em> to anything</strong>.</p>



<h2><a name="sql-indexes"></a>Indexes</h2>
<h3>Simple Description of Indexes</h3>

<p>Indexes speed up SELECT statements.</p>

<p>Normally, if you have a table of 10,000 rows, and you want row number
   8000, the database has to go through all 10,000 rows to find your row.
   That's called a &quot;table scan,&quot; and it's usually slow.</p>

<p>With an index, you ask it for &quot;row 8000&quot; and it gives it to you
   instantly.</p>

<h3>More Details</h3>

<p>OK, so in reality you wouldn't be asking for &quot;row 8000,&quot; you'd
   be doing something like <code>WHERE bugs.bug_id = 8000</code> in your SQL.</p>

<p>In order for the database to do that quickly, it needs an index on the 
   <code>bugs</code> table, on the <code>bug_id</code> column.</p>

<h3>When To Add An Index</h3>

<p>Generally, you should add an index any time you plan to use a column
   in a WHERE clause, or in the &quot;ON&quot; part of a JOIN statement.</p>

<p>Adding too many indexes to a table will slow down INSERT and UPDATE
   statements, so don't add indexes you don't need.</p>

<h3>Multi-Column Indexes</h3>

<p>Many databases (MySQL in particular) will only use <em>one index per 
   table per query</em>.</p>

<p>That is, imagine that we do: <code>SELECT * FROM bugs WHERE priority = 'P1' 
   OR op_sys = 'Windows'</code>. We have two indexes on the bugs table, one
   for &quot;priority&quot; and one for &quot;op_sys.&quot; <strong>Only one 
   of them will be used.</strong> The one that's used is up to the database,
   it will try to pick the &quot;best&quot; one to use, and then do a table
   scan for the other one.</p>

<p>If we want that to be fast, we can create a <em>single</em> index that
   contains the values for <em>both</em> <code>priority</code> and 
   <code>op_sys</code>. That is called a multi-column index.</p>

<p>Multi-column indexes are always in a certain order. For example, either
   &quot;op_sys, priority&quot; or &quot;priority, op_sys.&quot; For your
   purposes, those two indexes are <em>totally identical</em>, with one 
   exception: <strong>The first column of a multi-column index can be used
   like it's a single-column index.</strong> So, for example, having an
   index on both &quot;priority, op_sys&quot; and &quot;priority&quot; would
   be redundant. Don't do it.</p>

<h3>Write Queries With Indexes In Mind</h3>

<p>When writing a query, give a brief thought to how it will use indexes.
   Don't try to solve performance problems before you know they exist
   (remember our rules from the top of the Developer's Guide), but do
   give a brief thought to it, particularly the fact that only one index
   will be used per table, per query, by common databases.</p>


<h2><a name="sql-crossdb"></a>Cross-Database Query Compatibility</h2>

<p>Different databases support different things, and different databases
   use different syntax for similar features. <code>Bugzilla-&gt;dbh</code>
   provides many functions that will generate correct SQL for the database that 
   Bugzilla is using. These functions all have names that start with 
  <code>sql_</code>.</p>

<p>Here are the MySQL constructs that must be replaced with Bugzilla::DB
   <code>sql_</code> functions:</p>

<ul>
    <li><code>BEGIN/START [TRANSACTION] / COMMIT [TRANSACTION]</code></li>
    <li><code>REGEXP / NOT REGEXP</code></li>
    <li><code>LIMIT</code></li>
    <li><code>TO_DAYS</code></li>
    <li><code>DATE_FORMAT</code></li>
    <li><code>INTERVAL</code></li>
    <li><code>CONCAT</code></li>
    <li><code>INSTR / POSITION</code></li>
    <li><code><strong>GROUP BY</strong></code></li>
    <li><code>MATCH</code> or anything having to do with &quot;fulltext&quot; 
        indexes.</li>
</ul>

<p>Also, if you absolutely need to do a case-insensitive string comparison,
   use <code>sql_istrcmp</code> instead of <code>=</code> or other 
   operators.</p>

<p>The following SQL constructs should <em>never</em> be used. Replace them
   with something else instead:</p>

<ul>
    <li><code class="sql">ENCRYPT()</code> - use Perl's
        <code class="perl">bz_crypt</code> function instead.</li>
    <li>bit arithmetic (<code class="sql">AND</code>,
        <code class="sql">OR</code> and <code class="sql">NOT</code> on
        numbers)</li>
    <li><code class="sql">REPLACE INTO</code> - instead use a check if the
        row is there, and then either an INSERT or an UPDATE.</li>
    <li>double quotes (&quot;) for string literals - instead use single quotes
        or <code>$dbh-&gt;quote()</code>.</li>
    <li><code>IFNULL</code> (use <code>COALESCE</code>)</li>
    <li>Columns of MySQL type <code>ENUM</code> or <code>TIMESTAMP</code>.</li>
    <li>Any boolean comparison that is <em>inside the fields of a SELECT 
        statement</em>. For example <code>SELECT (column IS NOT NULL) FROM b</code>
        will <em>not</em> work. (Use <code>CASE WHEN column IS NOT NULL THEN 1 ELSE 
        0 END</code> instead.)</li>
    <li><code>WHERE</code> statements without an operator. For example,
        <code>SELECT column FROM b WHERE a</code> will <em>not</em> work.
        That needs to have: <code>WHERE a = 1</code>.</li>
    <li><code>IF</code> - use <code>CASE WHEN</code> instead.</li>
    <li><code>INSERT</code> statements with multiple groups of parentheses
        after VALUES. Instead, just call INSERT multiple times.</li>
</ul>

<p>The following query features are not currently available in all databases
   that Bugzilla supports, and so should be avoided:</p>

<ul>
   <li>Transactions (<code>START TRANSACTION</code> or <code>COMMIT</code>)</li>
   <li>Subselects (<code>SELECT * FROM (SELECT * FROM b)</code>)</li>
</ul>

<h3>A Note About INNER JOIN</h3>

<p>In general, <em>implicit</em> INNER JOINs (<code>FROM a, b WHERE 
   a.user_id = b.user_id</code>) are faster than <em>explicit</em> INNER JOINs
   (<code>FROM a INNER JOIN b ON a.user_id = b.user_id</code>). This is
   because explicit INNER JOINs bypass the query optimizer on some
   databases and specify that the database <em>must</em> use that table 
   order.</p>

<p>However, you can't mix explicit and implicit joins. It works on older
   MySQL versions (before 5.0), but that's it. So, if you have any
   LEFT JOIN statements in your SQL, you cannot have any &quot;comma&quot;
   joins.</p>

<p>In general, the performance penalty for explicit INNER JOINs should only
   happen on older databases (PostgreSQL before 7.4, for example), so don't
   worry about it too much. When in doubt, do an explicit join.</p>



<h2><a name="sql-style"></a>Style</h2>
<ul>
  <li>
    <p>Bugzilla uses a capitalisation convention for SQL. SQL keywords such as
       <code class="sql">SELECT</code>, <code class="sql">WHERE</code> and
       <code class="sql">AND</code> should be all upper case. Even
       function names like <code class="sql">NOW()</code> should be upper-case.
       Database, table and field names should be all lower case, for example:</p>
    <p><code class="sql">SELECT fieldname1 FROM tablename WHERE fieldname2 = 2 
        AND fieldname3 = 'HELLO' AND time = NOW()</code></p>
  </li>
  <li><strong>Indentation:</strong> For short SQL statements, you can
      indent them in whichever way you like. However, for long SQL statements,
      the recommended formatting is like this:

<pre>
SELECT DISTINCT groups.id, groups.name, groups.description
           FROM groups 
                CROSS JOIN user_group_map
                CROSS JOIN group_group_map AS ggm
          WHERE user_group_map.user_id = ?
                AND ((user_group_map.isbless = 1
                      AND groups.id = user_group_map.group_id)
                     OR (groups.id = ggm.grantor_id
                         AND ggm.grant_type = ?
                         AND ggm.member_id IN(1, 2, 3))))
       ORDER BY groups.id</pre>

      <p>Note how all the major keywords are right-aligned. This makes it
         very easy to scan through the statement. Also, look at how the
         WHERE clause is aligned--in such a way as to show the logical 
         groupings, but without a lot of extra spacing.</p>

      <p>Also, because it was such a complex query, we put the table name
         at the beginning of each column name. This makes it much easier
         to see where data is coming from, even if it's not always necessary.
         (For simple queries that query only one table, don't do that. It's
         obvious where the data is coming from.)</p>
  </li>
</ul>




<h1><a name="templates"></a>Templates</h1>
<h2><a name="templates-general"></a>General</h2>
<ul>
  <li>Bugzilla uses the Template Toolkit (TT) (module name
      <span class="module-name">Template</span>) to allow administrators to easily
      customise output and more importantly to allow Bugzilla to be fully localized.
      To learn more about TT, try <span class="shell-command">man Template::Manual</span>
      or go to <a href="http://www.template-toolkit.org/">http://www.template-toolkit.org/</a>.</li>
  <li>The testing suite will check that templates have no errors. This is
      done by running the template with the normal filters and no input. While
      this won't produce a sensible page, it will find many errors.
      Occasionally having no input can produce an error where none would have
      otherwise occurred, but this can generally be worked around by changing
      the template.</li>
  <li>
    <p>The testing suite will make sure you don't use the term <q>bug</q> or
       similar terms in templates. This term is customisable by the administrator in
       Bugzilla and you need to ensure your template uses the correct
       setting.</p>
    <p>Instead, you should use the terms hash, for example:</p>
    <code class="tt">
      [&#37; terms.bug &#37;]
    </code>
    <p>The terms hash is defined in the
       <span class="file-name">global/variables.none.tmpl</span> file.</p>
  </li>
  <li>You should use the supplied filters where available. See
      <span class="shell-command">man Template::Manual::Filters</span> for
      information on filters and list of the standard TT filters, and also see
      the template handling code in
      <span class="file-name">Bugzilla/Template.pm</span> for information on
      the extra filters defined by Bugzilla.</li>
  <li>If in doubt as to whether something should be done in a template or code,
      a good rule of thumb is <q>Code is for computing data, whereas templates
      are for presentation of that data.</q>.</li>
  <li>If you find that you need to do a presentation task that can't be easily
      done in TT, and needs Perl, then introduction of a new filter would
      likely be the appropriate solution.</li>
  <li>See the current templates for ideas on how to do stuff.</li>
  <li>
    <p>The testing suite will make sure every variable you insert into a
       template is filtered, except for text templates. This is to avoid bugs
       caused by forgetting to filter variables, especially cross-site 
       scripting security holes.</p>
    <p>If you really don't need to filter a variable, add it to the appropriate
       <span class="file-name">template/&lt;lang&gt;/default/filterexceptions.pl</span>
       file. This is generally not a good idea and should be avoided.</p>
    <p>See the section on HTML templates for more information about appropriate
       filtering practices in HTML templates.</p>
  </li>       
  <li>For repeated code, you should use blocks, including parameterised blocks.
      This means directives such as <code class="tt">PROCESS</code> and
      <code class="tt">INCLUDE</code>.</li>
  <li><code class="tt">PROCESS</code> is preferred for performance reasons over
      <code class="tt">INCLUDE</code>.  Only use
      <code class="tt">INCLUDE</code> when you need the template fragment to be
      able to change your variables.</li>
  <li>
    <p>To set up a template, make sure this code is near the start of your script:</p>
    <p><code>my $template = Bugzilla-&gt;template;<br />
       my $vars = {};</code></p>

    <p>and then you need to populate the <code class="perl">$vars</code> variable, for example:</p>
    <p><code class="perl">
      $vars-&gt;{'id'} = 3;<br>
      $vars-&gt;{'array'} = [ 'g', 'o' ];<br>
    </code></p>
    <p>See the appropriate sections below for information on how to output the template.</p>
  </li>
</ul>


<h2><a name="templates-filenames"></a>Filenames and Paths</h2>
<ul>
  <li>CGIs can use templates with the same interface of different "formats". These templates are called multiple format templates. Full
multiple-format templates should be named <span class="file-name">stubname-formatname.contentshortname.tmpl</span>, eg <span class="file-name">foo-traditional.html.tmpl</span>.</li>
  <li>Template "fragments" (files which are used by other files and are not intended to be used by themselves) and full single format templates should be named <span class="file-name">stubname.contentshortname.tmpl</span>, eg <span class="file-name">bar.html.tmpl</span>.</li>
  <li>All English templates should go in the <span class="file-name">template/en/default</span> hierachy. If you are introducing a new template, especially if you are introducing a new directory, please seek advice from the Bugzilla team for the proper exact location of the template.</li>
  <li>Stubnames should not use spaces or underscores, instead they should use hyphens to separate words.</li>
  <li>When choosing an appropriate stubname, you often want to use a verb-object name, eg <span class="file-name">destroy-widget.html.tmpl</span>.  When the object is obvious from the directory, you can omit it, eg <span class="file-name">widget/destroy.html.tmpl</span>.</li>
  <li>The terminology create/list/edit/created/delete is generally used in stubnames.  See the existing templates for stubname guidance.</li>
</ul>
                           

<h2><a name="templates-html"></a>HTML Templates</h2>
<ul>
  <li>
    <p>To output an HTML template to the browser, you can use this code:</p>
    <p><code class="perl">
      use Bugzilla;<br>
      ...<br>
      my $cgi = Bugzilla-&gt;cgi;<br>
      ...<br>
      print $cgi-&gt;header();<br>
      $template-&gt;process("file-name.html.tmpl", $vars)<br>
        &nbsp;&nbsp;|| ThrowTemplateError($template-&gt;error());<br>
    </code></p>
    <p>where <code class="perl">file-name.html.tmpl</code> is replaced by the
       appropriate filename. You can also pass a parameter to
       <code class="perl">header()</code> specifying the MIME type if it's
       not text/html.</p>
  </li>
  <li>Template Comments - You should generally use template comments rather than Javascript or HTML comments, so they don't bloat the output.</li>
  <li>Indentation - HTML and XML Templates should have a 2-space indent.
<pre><code class="perl">
&lt;fred&gt;
[&#37; IF foo &#37;]
  &lt;bar&gt;
  [&#37; FOREACH x = barney &#37;]
    &lt;tr&gt;
      &lt;td&gt;
        [&#37; x &#37;]
      &lt;/td&gt;
    &lt;tr&gt;
  [&#37; END &#37;]
[&#37; END &#37;]
&lt;/fred&gt; 
</code></pre><br>

    If you use VIm, then you can enter the following into <tt>.vimrc</tt> to help avoid tab symbols: <pre>  au BufNewFile,BufRead *.tmpl set et ts=2 sw=2 tw=80</pre></li>
  <li>Line Length - You shouldn't extend lines past 80 characters - instead, break lines, in the middle of multi-attributed HTML tags if necessary.</li>
  <li>Header/Footer - Full HTML Templates should use the <span class="file-name">global/header.html.tmpl</span> and <span class="file-name">global/footer.html.tmpl</span> templates.</li>
  <li>
    <p>You probably want to use the <code class="tt">html</code> filter on most variables, to ensure characters which have special meaning to HTML (like like &lt;, &gt; and &amp;), will be interpreted as normal characters.  For example:</p>
    <p><code class="tt">[&#37; myvar FILTER html &#37;]</code></p>
    <p>instead of:</p>
    <p><code class="tt">[&#37; myvar &#37;]</code></p>
    <p>So if myvar was "&lt;b&gt;hello&lt;/b&gt;", after filtering that string
       would appear as is on the page, rather than as bold text.</p>
    <p>If in doubt as to whether to use the <code class="tt">html</code> filter
       on a variable, because the variable probably never contains special
       characters, but should be filtered if it did, you should generally err
       on the side of caution and filter it anyway.</p>
  </li>
  <li>
    <p>When URIs appear in HTML, the <code class="tt">html</code> filter is not
       enough to properly escape strings into the format that can appear in a
       URI.</p>
    <p>TT provides a filter called <code class="tt">uri</code> that escapes
       characters such as spaces that are invalid in URIs. For example:
    </p>
    <p><code class="tt">&lt;a href="hello.cgi?name=[&#37; myvar FILTER uri &#37;]"&gt;</code></p>
    <p>This will escape most non-alphanumeric characters, even those that are
       valid and have no special meaning in URIs. In particular, it will encode
       all the HTML special characters (such as &lt; and &gt;), so you do not
       need to call the <code class="tt">html</code> filter as well afterwards.
    </p>
    <p>For example, consider the variable <code class="tt">myuri</code>
       containing the string "hello &amp;":
    <ul>
      <li>
        <p>When not filtered:</p>
        <p><code class="tt">&lt;a href="hello.cgi?name=[&#37; mytext &#37;]"&gt;</code></p>
        <p>would become:</p>
        <p><code class="html">&lt;a href="hello.cgi?name=hello &amp;"&gt;</code></p>
        <p>which is not valid HTML as the ampersand is not allowed raw in an attribute.</p>
      </li>
      <li>
        <p>When <code class="tt">html</code> filtered:</p>
        <p><code class="tt">&lt;a href="hello.cgi?name=[&#37; mytext FILTER html &#37;]"&gt;</code></p>
        <p>would become:</p>
        <p><code class="html">&lt;a href="hello.cgi?name=hello &amp;amp;"&gt;</code></p>
        <p>which would be valid HTML but an invalid URI:</p>
        <p><code class="uri">hello.cgi?name=hello &amp;</code></p>
        <p>as it contains a space.</p>
      </li>
      <li>
        <p>When <code class="tt">uri</code> filtered:</p>
        <p><code class="tt">&lt;a href="hello.cgi?name=[&#37; mytext FILTER uri &#37;]"&gt;</code></p>
        <p>would become:</p>
        <p><code class="html">&lt;a href="hello.cgi?name=hello&#37;20&#37;26"&gt;</code></p>
        <p>which is valid HTML and a valid URI:</p>
        <p><code class="uri">hello.cgi?name=hello&#37;20&#37;26</code></p>
        <p>and has the desired result of passing the whole <code class="tt">mytext</code> variable as the "name" parameter.<p>
      </li>
    </ul>
  </li>
</ul>


<h2><a name="templates-webtech"></a>Web Technologies</h2>
<ul>
  <li>HTML output should be valid <a href="http://www.w3.org/TR/html5/">HTML 5</a>.
      You can test the output of a Bugzilla page by using 
      the <a href="http://validator.w3.org/">W3C's HTML validator</a>.</li>
  <li>In addition, the HTML should use a style that makes them as XHTML compatible
      as is possible without failing to validate or causing compatibility problems.
      This means in particular using lower case tags and double quoting all attributes.</li>
  <li>Use the <code class="html">&lt;label&gt;</code> tag on checkboxes and radio
      buttons where appropriate. This will also help with accessibility.</li>
  <li>Bugzilla should work reasonably on all browsers.</li>
  <li>While Bugzilla uses Javascript and cookies to make the user experience
      easier, no patch to Bugzilla should <em>require</em> either. The only
      exception is that the administrative interfaces (the edit* CGIs) may 
      require JavaScript, as we expect the administrator to have a
      JavaScript-capable browser.</li>
</ul>



<h1><a name="security"></a>Security</h1>
<p>Please consider the security implications of your code. In particular,
   thoroughly check user permissions, and thoroughly check data is in the
   right format.</p>
<p>Perl is a reasonably secure language. Buffer overflow and format string 
   attacks are believed to not be possible.</p>
<p>Furthermore, Perl's taint mode can catch a wide range of failure-to-validate
   errors and transform them from potential security holes into mere 
   errors.</p>
<p>But there will always be security problems (see below), as no language can
   prevent all types of problem.</p>


<h2><a name="security-untrusted"></a>Don't Trust URL Parameters And Cookies!</h2>
<p>URL parameters and cookies are under the control of the user, and hence
   should not be trusted.  Make sure they are in the correct format before
   using them, and don't trust anything they say about the user's authority or
   identity, other than through the standard Bugzilla authentication
   mechanisms.</p>
<p>To find a user's identity, examine the properties of the User object returned
   by <code class="perl">Bugzilla-&gt;user</code> after the appropriate call to
   <code class="perl">Bugzilla-&gt;login</code>. See
   <a href="tip/html/api/Bugzilla/User.html">Bugzilla::User</a> for details.</p>


<h2><a name="security-confidential"></a>Confidential Information Leakage</h2>
<p>Bugzilla has various facilities to restrict products and bugs to users in
   certain groups. When users can bypass this mechanism, it is a 
   security hole.</p>
<p>This can occur when you fail to check appropriate permissions before doing
   something. Please consider this in your code.</p>
<p>Also, arbitrary user-passed SQL can be used in bug lists to return
   unexpected bugs, so you shouldn't allow it.</p>

<p>Note that even the name of a product can be confidential. Whenever possible,
   don't inform the user that something exists, if they can't access it.</p>


<h2><a name="security-unauthorized"></a>Unauthorised Access to Perform an Action</h2>
<p>This is allowing a user to do something they shouldn't be able to do,
   like edit a bug they don't have access to. Similar to confidential 
   information leakage, this also often occurs when you fail to do an 
   appropriate check.</p>


<h2><a name="security-arbitrarycode"></a>Arbitrary Code Execution</h2>
<p>This is a very serious hole, as it often has the potential to let the
   attacker do a wide range of things with a system. It occurs when a user can
   pass code that then runs, including Perl, HTML, shell-script or SQL.</p>
<p>Generally this isn't intentional, but instead occurs when you fail to
   properly validate or escape a string you pass as a part of some code.</p>
<p>Some instances of this should be picked up by taint mode:</p>
<ul>
  <li>Passing untrusted strings to SQL. Use placeholders instead of passing
      strings directly into SQL, and remember to <a href="#perl-taint">detaint
      the data</a> before passing it into the placeholder.</li>
  <li>Passing untrusted numbers to code. Use <code class="perl">detaint_natural</code> to validate and detaint the number.</li>
</ul>
<p>Some aren't, but will probably be picked up by the testing suite:</p>
<ul>
  <li>Using the multiple parameter form of <code class="perl">system</code> or <code class="perl">exec</code>.</li>
  <li>Passing untrusted strings to HTML. Use the <code class="tt">html</code> filter in TT.</li>
</ul>
                                      
